

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>main &mdash; CustomXepr v2.2.1 documentation</title>
  

  
  
  
  

  

  
  
    

  

  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" /> 

  
  <script src="../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../index.html" class="icon icon-home"> CustomXepr
          

          
            
            <img src="../_static/logo@2x.png" class="logo" alt="Logo"/>
          
          </a>

          
            
            
              <div class="version">
                v2.2.1
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../introduction.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../api/index.html">Modules</a></li>
<li class="toctree-l1"><a class="reference internal" href="../changelog.html">Changelog</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">CustomXepr</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html">Docs</a> &raquo;</li>
        
          <li><a href="index.html">Module code</a> &raquo;</li>
        
      <li>main</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for main</h1><div class="highlight"><pre>
<span></span><span class="ch">#!/usr/bin/env python3</span>
<span class="c1"># -*- coding: utf-8 -*-</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">@author: Sam Schott  (ss2151@cam.ac.uk)</span>

<span class="sd">(c) Sam Schott; This work is licensed under a Creative Commons</span>
<span class="sd">Attribution-NonCommercial-NoDerivs 2.0 UK: England &amp; Wales License.</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="k">import</span> <span class="n">division</span><span class="p">,</span> <span class="n">absolute_import</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">logging.handlers</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">from</span> <span class="nn">threading</span> <span class="k">import</span> <span class="n">Event</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">qtpy</span> <span class="k">import</span> <span class="n">QtCore</span>
<span class="kn">from</span> <span class="nn">keithleygui</span> <span class="k">import</span> <span class="n">CONF</span> <span class="k">as</span> <span class="n">K_CONF</span>

<span class="c1"># local imports</span>
<span class="kn">from</span> <span class="nn">customxepr.utils.mail</span> <span class="k">import</span> <span class="n">EmailSender</span>
<span class="kn">from</span> <span class="nn">customxepr.mode_picture</span> <span class="k">import</span> <span class="n">ModePicture</span>
<span class="kn">from</span> <span class="nn">customxepr.manager</span> <span class="k">import</span> <span class="n">ExperimentQueue</span><span class="p">,</span> <span class="n">SignalQueue</span><span class="p">,</span> <span class="n">Worker</span><span class="p">,</span> <span class="n">queued_exec</span>
<span class="kn">from</span> <span class="nn">customxepr.config.main</span> <span class="k">import</span> <span class="n">CONF</span>

<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">XeprAPI</span> <span class="k">import</span> <span class="n">ParameterError</span><span class="p">,</span> <span class="n">ExperimentError</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="n">ParameterError</span> <span class="o">=</span> <span class="n">ExperimentError</span> <span class="o">=</span> <span class="ne">RuntimeError</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;XeprAPI could not be located. Please make sure that &#39;</span> <span class="o">+</span>
                 <span class="s1">&#39;is installed on your system.&#39;</span><span class="p">)</span>


<span class="n">__author__</span> <span class="o">=</span> <span class="s1">&#39;Sam Schott &lt;ss2151@cam.ac.uk&gt;&#39;</span>
<span class="n">__year__</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">localtime</span><span class="p">()</span><span class="o">.</span><span class="n">tm_year</span><span class="p">)</span>
<span class="n">__version__</span> <span class="o">=</span> <span class="s1">&#39;v2.2.1&#39;</span>
<span class="n">__url__</span> <span class="o">=</span> <span class="s1">&#39;https://oe-fet.github.io/customxepr&#39;</span>

<span class="n">PY2</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">version</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;2&#39;</span>

<span class="c1"># add logging level for status updates between DEBUG (10) and INFO (20)</span>
<span class="n">logging</span><span class="o">.</span><span class="n">STATUS</span> <span class="o">=</span> <span class="mi">15</span>
<span class="n">logging</span><span class="o">.</span><span class="n">addLevelName</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">STATUS</span><span class="p">,</span> <span class="s1">&#39;STATUS&#39;</span><span class="p">)</span>
<span class="c1"># noinspection PyProtectedMember</span>
<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
<span class="n">logger</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">STATUS</span><span class="p">)</span>
<span class="c1"># noinspection PyUnresolvedReferences</span>
<span class="nb">setattr</span><span class="p">(</span><span class="n">logger</span><span class="p">,</span> <span class="s1">&#39;status&#39;</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">message</span><span class="p">,</span>
        <span class="o">*</span><span class="n">args</span><span class="p">:</span> <span class="n">logger</span><span class="o">.</span><span class="n">_log</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">STATUS</span><span class="p">,</span> <span class="n">message</span><span class="p">,</span> <span class="n">args</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">cmp</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
    <span class="k">return</span> <span class="nb">bool</span><span class="p">(</span><span class="n">a</span> <span class="o">&gt;</span> <span class="n">b</span><span class="p">)</span> <span class="o">-</span> <span class="nb">bool</span><span class="p">(</span><span class="n">a</span> <span class="o">&lt;</span> <span class="n">b</span><span class="p">)</span>  <span class="c1"># convert possible numpy-bool to bool</span>


<span class="c1"># noinspection PyUnresolvedReferences</span>
<div class="viewcode-block" id="CustomXepr"><a class="viewcode-back" href="../api/customxepr.html#main.CustomXepr">[docs]</a><span class="k">class</span> <span class="nc">CustomXepr</span><span class="p">(</span><span class="n">QtCore</span><span class="o">.</span><span class="n">QObject</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    CustomXepr defines routines to control the Bruker Xepr software and full ESR</span>
<span class="sd">    measurement cycles. This includes tuning and setting the temperature,</span>
<span class="sd">    applying voltages and recording IV characteristics with attached Keithley</span>
<span class="sd">    SMUs.</span>

<span class="sd">    All CustomXepr methods are executed in a worker thread in the order of</span>
<span class="sd">    their calls. To execute your own function in this thread, you can use</span>
<span class="sd">    the `queued_exec` decorator provided by customxepr and query the</span>
<span class="sd">    :attr:`abort_event` to support CustomXepr&#39;s abort functionality.</span>

<span class="sd">    All results are added to the result queue and can be retrieved with:</span>

<span class="sd">    &gt;&gt;&gt; result = customxepr.result_queue.get()  # blocks until result is available</span>

<span class="sd">    To pause or resume the worker between jobs, run</span>

<span class="sd">    &gt;&gt;&gt; customxepr.running.clear()</span>

<span class="sd">    or</span>

<span class="sd">    &gt;&gt;&gt; customxepr.running.set()</span>

<span class="sd">    To abort a job, run:</span>

<span class="sd">    &gt;&gt;&gt; customxepr.abort_event.set()</span>

<span class="sd">    You can use :class:`CustomXepr` on its own, but it is recommended to start</span>
<span class="sd">    it with the :func:`run` function in the :mod:`startup` module. This will</span>
<span class="sd">    automatically connect to available instruments and start the graphical user</span>
<span class="sd">    interfaces.</span>

<span class="sd">    :param xepr: Xepr instance from the Bruker Python XeprAPI. Defaults</span>
<span class="sd">        to `None` if not provided.</span>
<span class="sd">    :param mercuryfeed: :class:`mercurygui.MercuryFeed` instance for live feed from</span>
<span class="sd">        MercuryiTC temperature controller. Defaults to `None` if not provided.</span>
<span class="sd">    :param keithley: :class:`keithley2600.Keithley2600` instance from keithley2600</span>
<span class="sd">        driver. Defaults to `None` if not provided.</span>

<span class="sd">    :cvar job_queue: Queue that holds all experiments / jobs. Must be an instance</span>
<span class="sd">        of :class:`manager.ExperimentQueue`.</span>
<span class="sd">    :cvar result_queue:  Queue that holds job results. Must be an instance</span>
<span class="sd">        of :class:`manager.SignalQueue`.</span>
<span class="sd">    :cvar running: Instance of :class:`threading.Event`. If :attr:`running` is set,</span>
<span class="sd">        jobs will be processed in the background. Otherwise, job execution will</span>
<span class="sd">        be paused.</span>
<span class="sd">    :cvar abort: Instance of :class:`threading.Event` to abort currently running</span>
<span class="sd">        job. After the job has been aborted, the event will be cleared automatically.</span>

<span class="sd">    :ivar hidden: Xepr&#39;s hidden experiment.</span>
<span class="sd">    :ivar xepr: Connected Xepr instance.</span>
<span class="sd">    :ivar keithley: Connected :class:`keithley2600.Keithley2600` instance.</span>
<span class="sd">    :ivar feed: Connected :class:`mercurygui.MercuryFeed` instance.</span>
<span class="sd">    :ivar wait: Delay between commands sent to Xepr.</span>
<span class="sd">    &quot;&quot;&quot;</span>

<span class="c1"># =============================================================================</span>
<span class="c1"># Set up basic CustomXepr functionality</span>
<span class="c1"># =============================================================================</span>

    <span class="n">job_queue</span> <span class="o">=</span> <span class="n">ExperimentQueue</span><span class="p">()</span>
    <span class="n">result_queue</span> <span class="o">=</span> <span class="n">SignalQueue</span><span class="p">()</span>
    <span class="n">running</span> <span class="o">=</span> <span class="n">Event</span><span class="p">()</span>
    <span class="n">abort</span> <span class="o">=</span> <span class="n">Event</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">xepr</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">mercuryfeed</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">keithley</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>

        <span class="nb">super</span><span class="p">(</span><span class="n">CustomXepr</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">emailSender</span> <span class="o">=</span> <span class="n">EmailSender</span><span class="p">(</span><span class="s1">&#39;ss2151@cam.ac.uk&#39;</span><span class="p">,</span> <span class="s1">&#39;localhost&#39;</span><span class="p">,</span>
                                       <span class="n">displayname</span><span class="o">=</span><span class="s1">&#39;Sam Schott&#39;</span><span class="p">)</span>

        <span class="c1"># =====================================================================</span>
        <span class="c1"># check if connections to Xepr, MercuryiTC and Keithley are present</span>
        <span class="c1"># =====================================================================</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">xepr</span> <span class="o">=</span> <span class="n">xepr</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">feed</span> <span class="o">=</span> <span class="n">mercuryfeed</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">keithley</span> <span class="o">=</span> <span class="n">keithley</span>

        <span class="c1"># hidden Xepr experiment, created when EPR is connected:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hidden</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="c1"># target temperature, set during first use</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_temperature_target</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_check_for_xepr</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_check_for_mercury</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_check_for_keithley</span><span class="p">()</span>

        <span class="c1"># =====================================================================</span>
        <span class="c1"># create background thread to process all executions in queue</span>
        <span class="c1"># =====================================================================</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">worker_thread</span> <span class="o">=</span> <span class="n">QtCore</span><span class="o">.</span><span class="n">QThread</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">worker_thread</span><span class="o">.</span><span class="n">setObjectName</span><span class="p">(</span><span class="s1">&#39;CustomXeprWorker&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">worker</span> <span class="o">=</span> <span class="n">Worker</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">job_queue</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">result_queue</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">running</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">abort</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">worker</span><span class="o">.</span><span class="n">moveToThread</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">worker_thread</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">worker_thread</span><span class="o">.</span><span class="n">started</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">worker</span><span class="o">.</span><span class="n">process</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">worker_thread</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">running</span><span class="o">.</span><span class="n">set</span><span class="p">()</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">status</span><span class="p">(</span><span class="s1">&#39;IDLE&#39;</span><span class="p">)</span>

        <span class="c1"># =====================================================================</span>
        <span class="c1"># define / load certain settings for customxepr functions</span>
        <span class="c1"># =====================================================================</span>

        <span class="c1"># waiting time for Xepr to process commands, prevent memory error</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wait</span> <span class="o">=</span> <span class="mf">0.5</span>
        <span class="c1"># settling time for cryostat temperature</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_temp_wait_time</span> <span class="o">=</span> <span class="n">CONF</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;CustomXepr&#39;</span><span class="p">,</span> <span class="s1">&#39;temp_wait_time&#39;</span><span class="p">)</span>
        <span class="c1"># temperature stability tolerance</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_temperature_tolerance</span> <span class="o">=</span> <span class="n">CONF</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;CustomXepr&#39;</span><span class="p">,</span>
                                               <span class="s1">&#39;temperature_tolerance&#39;</span><span class="p">)</span>

<span class="c1"># =============================================================================</span>
<span class="c1"># define basic functions for email notifications, pausing, etc.</span>
<span class="c1"># =============================================================================</span>

<div class="viewcode-block" id="CustomXepr.clear_all_jobs"><a class="viewcode-back" href="../api/customxepr.html#main.CustomXepr.clear_all_jobs">[docs]</a>    <span class="k">def</span> <span class="nf">clear_all_jobs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Clears all pending jobs in :attr:`job_queue`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_queue</span><span class="o">.</span><span class="n">qsize</span><span class="p">()):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">job_queue</span><span class="o">.</span><span class="n">get</span><span class="p">()</span></div>

<div class="viewcode-block" id="CustomXepr.sendEmail"><a class="viewcode-back" href="../api/customxepr.html#main.CustomXepr.sendEmail">[docs]</a>    <span class="nd">@queued_exec</span><span class="p">(</span><span class="n">job_queue</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">sendEmail</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">body</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Sends a text to the default email address.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">emailSender</span><span class="o">.</span><span class="n">sendmail</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">notify_address</span><span class="p">,</span>
                                  <span class="s1">&#39;CustomXepr Notification&#39;</span><span class="p">,</span> <span class="n">body</span><span class="p">)</span></div>

<div class="viewcode-block" id="CustomXepr.pause"><a class="viewcode-back" href="../api/customxepr.html#main.CustomXepr.pause">[docs]</a>    <span class="nd">@queued_exec</span><span class="p">(</span><span class="n">job_queue</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">pause</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">seconds</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Pauses for the specified amount of seconds. This pause function checks</span>
<span class="sd">        for an abort signal every minute to prevent permanent blocking.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">eta</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">+</span> <span class="n">seconds</span>
        <span class="n">eta_string</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%H:%M&#39;</span><span class="p">,</span> <span class="n">time</span><span class="o">.</span><span class="n">localtime</span><span class="p">(</span><span class="n">eta</span><span class="p">))</span>
        <span class="n">message</span> <span class="o">=</span> <span class="s1">&#39;Waiting for </span><span class="si">%s</span><span class="s1"> seconds, ETA: </span><span class="si">%s</span><span class="s1">.&#39;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">message</span> <span class="o">%</span> <span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">seconds</span><span class="p">),</span> <span class="n">eta_string</span><span class="p">))</span>

        <span class="c1"># brake up into 1 sec sleep intervals, give option to abort</span>
        <span class="k">if</span> <span class="n">seconds</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">seconds</span><span class="p">):</span>
                <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">status</span><span class="p">(</span><span class="s1">&#39;Waiting </span><span class="si">%s</span><span class="s1">/</span><span class="si">%s</span><span class="s1">.&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">seconds</span><span class="p">))</span>
                <span class="c1"># check for abort event</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">abort</span><span class="o">.</span><span class="n">is_set</span><span class="p">():</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Aborted by user.&#39;</span><span class="p">)</span>
                    <span class="k">return</span>
        <span class="c1"># use a single sleep command for less than one second pause</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">seconds</span><span class="p">)</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">temp_wait_time</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Wait time until temperature is considered stable. Defaults to 120 sec.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_temp_wait_time</span>

    <span class="nd">@temp_wait_time</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">temp_wait_time</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">new_time</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Setter: Wait time until temperature is considered stable.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_temp_wait_time</span> <span class="o">=</span> <span class="n">new_time</span>
        <span class="c1"># update config file</span>
        <span class="n">CONF</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;CustomXepr&#39;</span><span class="p">,</span> <span class="s1">&#39;temp_wait_time&#39;</span><span class="p">,</span> <span class="n">new_time</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">temperature_tolerance</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Temperature fluctuation tolerance. Defaults to 0.1 Kelvin.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_temperature_tolerance</span>

    <span class="nd">@temperature_tolerance</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">temperature_tolerance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">new_tol</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Setter: Temperature fluctuation tolerance.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_temperature_tolerance</span> <span class="o">=</span> <span class="n">new_tol</span>
        <span class="c1"># update config file</span>
        <span class="n">CONF</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;CustomXepr&#39;</span><span class="p">,</span> <span class="s1">&#39;temperature_tolerance&#39;</span><span class="p">,</span> <span class="n">new_tol</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">notify_address</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Address list for email notifications.&quot;&quot;&quot;</span>
        <span class="c1"># get root logger</span>
        <span class="n">root_logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">()</span>
        <span class="c1"># find all email handlers (there should be only one)</span>
        <span class="n">eh</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">root_logger</span><span class="o">.</span><span class="n">handlers</span> <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">==</span> <span class="n">logging</span><span class="o">.</span><span class="n">handlers</span><span class="o">.</span><span class="n">SMTPHandler</span><span class="p">]</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">eh</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;No email handler could be found.&#39;</span><span class="p">)</span>

        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">eh</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c1"># get emails from all handlers</span>
            <span class="n">email_list</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">handler</span> <span class="ow">in</span> <span class="n">eh</span><span class="p">:</span>
                <span class="n">email_list</span> <span class="o">+=</span> <span class="n">handler</span><span class="o">.</span><span class="n">toaddrs</span>
            <span class="c1"># remove duplicates and return</span>
            <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">email_list</span><span class="p">))</span>

    <span class="nd">@notify_address</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">notify_address</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">email_list</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Setter: Address list for email notifications.&quot;&quot;&quot;</span>
        <span class="c1"># get root logger</span>
        <span class="n">root_logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">()</span>
        <span class="c1"># find all email handlers (there should be only one)</span>
        <span class="n">eh</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">root_logger</span><span class="o">.</span><span class="n">handlers</span> <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">==</span> <span class="n">logging</span><span class="o">.</span><span class="n">handlers</span><span class="o">.</span><span class="n">SMTPHandler</span><span class="p">]</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">eh</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;No email handler could be found.&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">eh</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">handler</span> <span class="ow">in</span> <span class="n">eh</span><span class="p">:</span>
                <span class="n">handler</span><span class="o">.</span><span class="n">toaddrs</span> <span class="o">=</span> <span class="n">email_list</span>

        <span class="n">email_list_str</span> <span class="o">=</span> <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">email_list</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Email notifications will be sent to &#39;</span>
                    <span class="o">+</span> <span class="n">email_list_str</span> <span class="o">+</span> <span class="s1">&#39;.&#39;</span><span class="p">)</span>

        <span class="c1"># update conf file</span>
        <span class="n">CONF</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;CustomXepr&#39;</span><span class="p">,</span> <span class="s1">&#39;notify_address&#39;</span><span class="p">,</span> <span class="n">email_list</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">log_file_dir</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Directory for log files. Defaults to &#39;~/.CustomXepr&#39;.&quot;&quot;&quot;</span>
        <span class="c1"># get root logger</span>
        <span class="n">root_log</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">()</span>
        <span class="c1"># find all email handlers (there should be only one)</span>
        <span class="n">fh</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">root_log</span><span class="o">.</span><span class="n">handlers</span> <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">==</span> <span class="n">logging</span><span class="o">.</span><span class="n">FileHandler</span><span class="p">]</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">fh</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;No file handler could be found.&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">file_name</span> <span class="o">=</span> <span class="n">fh</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">baseFilename</span>
            <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">file_name</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">email_handler_level</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Logging level for email notifications. Defaults to :class:`logging.WARNING`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># get root logger</span>
        <span class="n">root_logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">()</span>
        <span class="c1"># find all email handlers (there should be only one)</span>
        <span class="n">eh</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">root_logger</span><span class="o">.</span><span class="n">handlers</span> <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">==</span> <span class="n">logging</span><span class="o">.</span><span class="n">handlers</span><span class="o">.</span><span class="n">SMTPHandler</span><span class="p">]</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">eh</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;No email handler could be found.&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">eh</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">level</span>

    <span class="nd">@email_handler_level</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">email_handler_level</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">WARNING</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Setter: Logging level for email notifications.&quot;&quot;&quot;</span>
        <span class="c1"># get root logger</span>
        <span class="n">root_logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">()</span>
        <span class="c1"># find all email handlers (there should be only one)</span>
        <span class="n">eh</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">root_logger</span><span class="o">.</span><span class="n">handlers</span> <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">==</span> <span class="n">logging</span><span class="o">.</span><span class="n">handlers</span><span class="o">.</span><span class="n">SMTPHandler</span><span class="p">]</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">eh</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;No email handler could be found.&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">eh</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">level</span><span class="p">)</span>
        <span class="c1"># update conf file</span>
        <span class="n">CONF</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;CustomXepr&#39;</span><span class="p">,</span> <span class="s1">&#39;email_handler_level&#39;</span><span class="p">,</span> <span class="n">level</span><span class="p">)</span>

<span class="c1"># =============================================================================</span>
<span class="c1"># set up Xepr functions</span>
<span class="c1"># =============================================================================</span>

<div class="viewcode-block" id="CustomXepr.tune"><a class="viewcode-back" href="../api/customxepr.html#main.CustomXepr.tune">[docs]</a>    <span class="nd">@queued_exec</span><span class="p">(</span><span class="n">job_queue</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">tune</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Runs Xepr&#39;s built-in tuning routine.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_for_xepr</span><span class="p">():</span>
            <span class="k">return</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">XeprCmds</span><span class="o">.</span><span class="n">aqParSet</span><span class="p">(</span><span class="s1">&#39;AcqHidden&#39;</span><span class="p">,</span> <span class="s1">&#39;*cwBridge.OpMode&#39;</span><span class="p">,</span> <span class="s1">&#39;Tune&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">XeprCmds</span><span class="o">.</span><span class="n">aqParSet</span><span class="p">(</span><span class="s1">&#39;AcqHidden&#39;</span><span class="p">,</span> <span class="s1">&#39;*cwBridge.Tune&#39;</span><span class="p">,</span> <span class="s1">&#39;Up&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="CustomXepr.finetune"><a class="viewcode-back" href="../api/customxepr.html#main.CustomXepr.finetune">[docs]</a>    <span class="nd">@queued_exec</span><span class="p">(</span><span class="n">job_queue</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">finetune</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Runs Xepr&#39;s built-in finetuning routine.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_for_xepr</span><span class="p">():</span>
            <span class="k">return</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">XeprCmds</span><span class="o">.</span><span class="n">aqParSet</span><span class="p">(</span><span class="s1">&#39;AcqHidden&#39;</span><span class="p">,</span> <span class="s1">&#39;*cwBridge.Tune&#39;</span><span class="p">,</span> <span class="s1">&#39;Fine&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="CustomXepr.customtune"><a class="viewcode-back" href="../api/customxepr.html#main.CustomXepr.customtune">[docs]</a>    <span class="nd">@queued_exec</span><span class="p">(</span><span class="n">job_queue</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">customtune</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Custom tuning routine with better accuracy. It takes longer than :meth:`tune`</span>
<span class="sd">        and requires the spectrometer to be be already close to tuned.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_for_xepr</span><span class="p">():</span>
            <span class="k">return</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Tuning.&#39;</span><span class="p">)</span>

        <span class="c1"># save current operation mode and attenuation</span>
        <span class="n">mode</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hidden</span><span class="p">[</span><span class="s1">&#39;OpMode&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wait</span><span class="p">)</span>
        <span class="n">atten_start</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hidden</span><span class="p">[</span><span class="s1">&#39;PowerAtten&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wait</span><span class="p">)</span>

        <span class="c1"># switch mode to &#39;Operate&#39;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;Operate&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">hidden</span><span class="p">[</span><span class="s1">&#39;OpMode&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="s1">&#39;Operate&#39;</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wait</span><span class="p">)</span>

        <span class="c1"># tune frequency at 30 dB</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hidden</span><span class="p">[</span><span class="s1">&#39;PowerAtten&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="mi">30</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wait</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tuneFreq</span><span class="p">()</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wait</span><span class="p">)</span>

        <span class="c1"># tune bias of reference arm at 50 dB</span>
        <span class="c1"># (where diode current is determined by reference arm)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hidden</span><span class="p">[</span><span class="s1">&#39;PowerAtten&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="mi">50</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wait</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tuneBias</span><span class="p">()</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wait</span><span class="p">)</span>

        <span class="c1"># tune iris at 40 dB and 30 dB</span>
        <span class="k">for</span> <span class="n">atten</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">40</span><span class="p">,</span> <span class="mi">30</span><span class="p">]:</span>
            <span class="c1"># check for abort event</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">abort</span><span class="o">.</span><span class="n">is_set</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">hidden</span><span class="p">[</span><span class="s1">&#39;PowerAtten&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">atten_start</span>
                <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wait</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Aborted by user.&#39;</span><span class="p">)</span>
                <span class="k">return</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">hidden</span><span class="p">[</span><span class="s1">&#39;PowerAtten&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">atten</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wait</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">tuneIris</span><span class="p">()</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wait</span><span class="p">)</span>

        <span class="c1"># tune iris and phase and frequency at 20 dB and 10 dB</span>
        <span class="k">for</span> <span class="n">atten</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">20</span><span class="p">,</span> <span class="mi">10</span><span class="p">]:</span>
            <span class="c1"># check for abort event, clear event</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">abort</span><span class="o">.</span><span class="n">is_set</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">hidden</span><span class="p">[</span><span class="s1">&#39;PowerAtten&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">atten_start</span>
                <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wait</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Aborted by user.&#39;</span><span class="p">)</span>
                <span class="k">return</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">hidden</span><span class="p">[</span><span class="s1">&#39;PowerAtten&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">atten</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wait</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tunePhase</span><span class="p">()</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wait</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tuneIris</span><span class="p">()</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wait</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tuneFreq</span><span class="p">()</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wait</span><span class="p">)</span>

        <span class="c1"># tune bias at 50 dB</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hidden</span><span class="p">[</span><span class="s1">&#39;PowerAtten&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="mi">50</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wait</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tuneBias</span><span class="p">()</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wait</span><span class="p">)</span>

        <span class="c1"># tune iris at 15 dB</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hidden</span><span class="p">[</span><span class="s1">&#39;PowerAtten&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="mi">20</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wait</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tuneIris</span><span class="p">()</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wait</span><span class="p">)</span>

        <span class="c1"># tune bias at 50 dB</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hidden</span><span class="p">[</span><span class="s1">&#39;PowerAtten&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="mi">50</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wait</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tuneBias</span><span class="p">()</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wait</span><span class="p">)</span>

        <span class="c1"># tune iris at 10 dB</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hidden</span><span class="p">[</span><span class="s1">&#39;PowerAtten&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="mi">10</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wait</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tuneIris</span><span class="p">()</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wait</span><span class="p">)</span>

        <span class="c1"># reset attenuation to original value, tune frequency again</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hidden</span><span class="p">[</span><span class="s1">&#39;PowerAtten&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">atten_start</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wait</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tuneFreq</span><span class="p">()</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wait</span><span class="p">)</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">status</span><span class="p">(</span><span class="s1">&#39;Tuning done.&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="CustomXepr.tuneBias"><a class="viewcode-back" href="../api/customxepr.html#main.CustomXepr.tuneBias">[docs]</a>    <span class="k">def</span> <span class="nf">tuneBias</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Tunes the diode bias. A perfectly tuned bias results in a diode</span>
<span class="sd">        current of 200 mA for all microwave powers.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># check for abort event</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">abort</span><span class="o">.</span><span class="n">is_set</span><span class="p">():</span>
            <span class="k">return</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">status</span><span class="p">(</span><span class="s1">&#39;Tuning (Bias).&#39;</span><span class="p">)</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wait</span><span class="p">)</span>

        <span class="c1"># get offset from 200 mA</span>
        <span class="n">diff</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hidden</span><span class="p">[</span><span class="s1">&#39;DiodeCurrent&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span> <span class="o">-</span> <span class="mi">200</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wait</span><span class="p">)</span>
        <span class="n">tolerance1</span> <span class="o">=</span> <span class="mi">10</span>  <span class="c1"># tolerance for fast tuning</span>
        <span class="n">tolerance2</span> <span class="o">=</span> <span class="mi">1</span>  <span class="c1"># tolerance for second fine tuning</span>

        <span class="c1"># rapid tuning with high tolerance and large steps</span>
        <span class="k">while</span> <span class="nb">abs</span><span class="p">(</span><span class="n">diff</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">tolerance1</span><span class="p">:</span>
            <span class="c1"># check for abort event</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">abort</span><span class="o">.</span><span class="n">is_set</span><span class="p">():</span>
                <span class="k">return</span>

            <span class="n">step</span> <span class="o">=</span> <span class="mi">1</span><span class="o">*</span><span class="nb">cmp</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">diff</span><span class="p">)</span>  <span class="c1"># coarse step of 1</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">XeprCmds</span><span class="o">.</span><span class="n">aqParStep</span><span class="p">(</span><span class="s1">&#39;AcqHidden&#39;</span><span class="p">,</span> <span class="s1">&#39;*cwBridge.SignalBias&#39;</span><span class="p">,</span>
                                    <span class="s1">&#39;Coarse </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">step</span><span class="p">)</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.5</span><span class="p">)</span>
            <span class="n">diff</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hidden</span><span class="p">[</span><span class="s1">&#39;DiodeCurrent&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span> <span class="o">-</span> <span class="mi">200</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wait</span><span class="p">)</span>

        <span class="c1"># fine tuning with low tolerance and small steps</span>
        <span class="k">while</span> <span class="nb">abs</span><span class="p">(</span><span class="n">diff</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">tolerance2</span><span class="p">:</span>
            <span class="c1"># check for abort event</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">abort</span><span class="o">.</span><span class="n">is_set</span><span class="p">():</span>
                <span class="k">return</span>

            <span class="n">step</span> <span class="o">=</span> <span class="mi">5</span><span class="o">*</span><span class="nb">cmp</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">diff</span><span class="p">)</span>  <span class="c1"># fine step of 5</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">XeprCmds</span><span class="o">.</span><span class="n">aqParStep</span><span class="p">(</span><span class="s1">&#39;AcqHidden&#39;</span><span class="p">,</span> <span class="s1">&#39;*cwBridge.SignalBias&#39;</span><span class="p">,</span>
                                    <span class="s1">&#39;Fine </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">step</span><span class="p">)</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.5</span><span class="p">)</span>
            <span class="n">diff</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hidden</span><span class="p">[</span><span class="s1">&#39;DiodeCurrent&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span> <span class="o">-</span> <span class="mi">200</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wait</span><span class="p">)</span></div>

<div class="viewcode-block" id="CustomXepr.tuneIris"><a class="viewcode-back" href="../api/customxepr.html#main.CustomXepr.tuneIris">[docs]</a>    <span class="k">def</span> <span class="nf">tuneIris</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tolerance</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Tunes the cavity&#39;s iris. A perfectly tuned iris results in a diode</span>
<span class="sd">        current of 200 mA for all microwave powers.</span>

<span class="sd">        :param int tolerance: Minimum diode current offset that must be achieved</span>
<span class="sd">            before :meth:`tuneIris` returns.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># check for abort event</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">abort</span><span class="o">.</span><span class="n">is_set</span><span class="p">():</span>
            <span class="k">return</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">status</span><span class="p">(</span><span class="s1">&#39;Tuning (Iris).&#39;</span><span class="p">)</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wait</span><span class="p">)</span>

        <span class="n">diff</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hidden</span><span class="p">[</span><span class="s1">&#39;DiodeCurrent&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span> <span class="o">-</span> <span class="mi">200</span>

        <span class="k">while</span> <span class="nb">abs</span><span class="p">(</span><span class="n">diff</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">tolerance</span><span class="p">:</span>
            <span class="c1"># check for abort event</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">abort</span><span class="o">.</span><span class="n">is_set</span><span class="p">():</span>
                <span class="k">return</span>

            <span class="k">if</span> <span class="n">diff</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">cmd</span> <span class="o">=</span> <span class="s1">&#39;*cwBridge.IrisUp&#39;</span>
            <span class="k">elif</span> <span class="n">diff</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">cmd</span> <span class="o">=</span> <span class="s1">&#39;*cwBridge.IrisDown&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span>

            <span class="c1"># determine step size for iris adjustment: slower adjustment when</span>
            <span class="c1"># close to a diode current of 200, minimum step size of 0.3</span>
            <span class="n">step_size</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">diff</span><span class="p">),</span> <span class="mi">30</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.01</span>
            <span class="c1"># scale step size for MW power: smaller steps at higher power</span>
            <span class="n">step</span> <span class="o">=</span> <span class="n">step_size</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hidden</span><span class="p">[</span><span class="s1">&#39;PowerAtten&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="mi">400</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wait</span><span class="p">)</span>
            <span class="c1"># set value to 0.1 if step is smaller</span>
            <span class="c1"># (usually only happens below 10dB)</span>
            <span class="n">step</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">step</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">)</span>
            <span class="c1"># increase waiting time between steps when close to tuned</span>
            <span class="c1"># with a maximum waiting of 1 sec</span>
            <span class="n">wait</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="mi">5</span><span class="o">/</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">diff</span><span class="p">)</span> <span class="o">+</span> <span class="mf">0.1</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">XeprCmds</span><span class="o">.</span><span class="n">aqParSet</span><span class="p">(</span><span class="s1">&#39;AcqHidden&#39;</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="s1">&#39;True&#39;</span><span class="p">)</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">step</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">XeprCmds</span><span class="o">.</span><span class="n">aqParSet</span><span class="p">(</span><span class="s1">&#39;AcqHidden&#39;</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="s1">&#39;False&#39;</span><span class="p">)</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">wait</span><span class="p">)</span>

            <span class="n">diff</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hidden</span><span class="p">[</span><span class="s1">&#39;DiodeCurrent&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span> <span class="o">-</span> <span class="mi">200</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wait</span><span class="p">)</span></div>

<div class="viewcode-block" id="CustomXepr.tuneFreq"><a class="viewcode-back" href="../api/customxepr.html#main.CustomXepr.tuneFreq">[docs]</a>    <span class="k">def</span> <span class="nf">tuneFreq</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tolerance</span><span class="o">=</span><span class="mi">3</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Tunes the microwave frequency to a lock offset of zero.</span>

<span class="sd">        :param int tolerance: Minimum frequency offset that must be achieved</span>
<span class="sd">            before :meth:`tuneFreq` returns.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># check for abort event</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">abort</span><span class="o">.</span><span class="n">is_set</span><span class="p">():</span>
            <span class="k">return</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">status</span><span class="p">(</span><span class="s1">&#39;Tuning (Freq).&#39;</span><span class="p">)</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wait</span><span class="p">)</span>

        <span class="n">fq_offset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hidden</span><span class="p">[</span><span class="s1">&#39;LockOffset&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wait</span><span class="p">)</span>

        <span class="k">while</span> <span class="nb">abs</span><span class="p">(</span><span class="n">fq_offset</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">tolerance</span><span class="p">:</span>
            <span class="c1"># check for abort event</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">abort</span><span class="o">.</span><span class="n">is_set</span><span class="p">():</span>
                <span class="k">return</span>

            <span class="n">step</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">*</span> <span class="nb">cmp</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">fq_offset</span><span class="p">)</span> <span class="o">*</span> <span class="nb">max</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">fq_offset</span><span class="o">/</span><span class="mi">10</span><span class="p">)),</span> <span class="mi">1</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">XeprCmds</span><span class="o">.</span><span class="n">aqParStep</span><span class="p">(</span><span class="s1">&#39;AcqHidden&#39;</span><span class="p">,</span> <span class="s1">&#39;*cwBridge.Frequency&#39;</span><span class="p">,</span>
                                    <span class="s1">&#39;Fine </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">step</span><span class="p">)</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">fq_offset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hidden</span><span class="p">[</span><span class="s1">&#39;LockOffset&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wait</span><span class="p">)</span></div>

<div class="viewcode-block" id="CustomXepr.tunePhase"><a class="viewcode-back" href="../api/customxepr.html#main.CustomXepr.tunePhase">[docs]</a>    <span class="k">def</span> <span class="nf">tunePhase</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Tunes the phase of the MW reference arm to maximise the diode current.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># timeout for phase tuning</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_tuning_timeout</span> <span class="o">=</span> <span class="mi">60</span>
        <span class="c1"># check for abort event</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">abort</span><span class="o">.</span><span class="n">is_set</span><span class="p">():</span>
                <span class="k">return</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">status</span><span class="p">(</span><span class="s1">&#39;Tuning (Phase).&#39;</span><span class="p">)</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wait</span><span class="p">)</span>

        <span class="n">t0</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

        <span class="c1"># get current phase and range</span>
        <span class="n">phase0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hidden</span><span class="p">[</span><span class="s1">&#39;SignalPhase&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wait</span><span class="p">)</span>
        <span class="n">phase_min</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hidden</span><span class="p">[</span><span class="s1">&#39;SignalPhase&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">aqGetParMinValue</span><span class="p">()</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wait</span><span class="p">)</span>
        <span class="n">phase_max</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hidden</span><span class="p">[</span><span class="s1">&#39;SignalPhase&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">aqGetParMaxValue</span><span class="p">()</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wait</span><span class="p">)</span>
        <span class="n">phase_step</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hidden</span><span class="p">[</span><span class="s1">&#39;SignalPhase&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">aqGetParCoarseSteps</span><span class="p">()</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wait</span><span class="p">)</span>

        <span class="c1"># determine direction of increasing diode current</span>
        <span class="n">diode_curr_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span>
        <span class="n">interval_min</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">phase0</span><span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="n">phase_step</span><span class="p">,</span> <span class="n">phase_min</span><span class="p">)</span>
        <span class="n">interval_max</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">phase0</span><span class="o">+</span><span class="mi">2</span><span class="o">*</span><span class="n">phase_step</span><span class="p">,</span> <span class="n">phase_max</span><span class="p">)</span>
        <span class="n">phase_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">interval_min</span><span class="p">,</span> <span class="n">interval_max</span><span class="p">,</span> <span class="n">phase_step</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">phase</span> <span class="ow">in</span> <span class="n">phase_array</span><span class="p">:</span>
            <span class="c1"># check for abort event</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">abort</span><span class="o">.</span><span class="n">is_set</span><span class="p">():</span>
                <span class="k">return</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">hidden</span><span class="p">[</span><span class="s1">&#39;SignalPhase&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">phase</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wait</span><span class="p">)</span>
            <span class="n">diode_curr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hidden</span><span class="p">[</span><span class="s1">&#39;DiodeCurrent&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wait</span><span class="p">)</span>
            <span class="n">diode_curr_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">diode_curr_array</span><span class="p">,</span> <span class="n">diode_curr</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">t0</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tuning_timeout</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;Phase tuning timeout.&#39;</span><span class="p">)</span>
                <span class="k">break</span>

        <span class="c1"># Determine position of maximum phase by stepping the phase until it</span>
        <span class="c1"># decreases again. Shift by 360 if maximum or minimum is encountered.</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">hidden</span><span class="p">[</span><span class="s1">&#39;SignalPhase&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">phase0</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wait</span><span class="p">)</span>

        <span class="n">upper</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">diode_curr_array</span><span class="p">[</span><span class="n">phase_array</span> <span class="o">&gt;</span> <span class="n">phase0</span><span class="p">])</span>
        <span class="n">lower</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">diode_curr_array</span><span class="p">[</span><span class="n">phase_array</span> <span class="o">&lt;</span> <span class="n">phase0</span><span class="p">])</span>

        <span class="n">direction</span> <span class="o">=</span> <span class="nb">cmp</span><span class="p">(</span><span class="n">upper</span><span class="p">,</span> <span class="n">lower</span><span class="p">)</span>
        <span class="n">diode_curr_array</span> <span class="o">=</span> <span class="n">phase_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span>

        <span class="n">new_phase</span> <span class="o">=</span> <span class="n">phase0</span> <span class="o">+</span> <span class="n">direction</span><span class="o">*</span><span class="n">phase_step</span>

        <span class="c1"># Check if phase is within limits, then step. otherwise shift phase</span>
        <span class="c1"># and return.</span>
        <span class="n">deg_step</span> <span class="o">=</span> <span class="mf">6.5</span>  <span class="c1"># approximate step of 1 deg</span>
        <span class="k">if</span> <span class="n">new_phase</span> <span class="o">&gt;</span> <span class="n">phase_max</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Phase at upper limit, reducing by 360 deg.&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">hidden</span><span class="p">[</span><span class="s1">&#39;SignalPhase&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">phase0</span> <span class="o">-</span> <span class="mi">360</span><span class="o">*</span><span class="n">deg_step</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="k">elif</span> <span class="n">new_phase</span> <span class="o">&lt;</span> <span class="n">phase_min</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Phase at lower limit, increasing by 360 deg.&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">hidden</span><span class="p">[</span><span class="s1">&#39;SignalPhase&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">phase0</span> <span class="o">+</span> <span class="mi">360</span><span class="o">*</span><span class="n">deg_step</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">hidden</span><span class="p">[</span><span class="s1">&#39;SignalPhase&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">new_phase</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wait</span><span class="p">)</span>

        <span class="n">diode_curr_new</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hidden</span><span class="p">[</span><span class="s1">&#39;DiodeCurrent&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wait</span><span class="p">)</span>
        <span class="n">diode_curr_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">diode_curr_array</span><span class="p">,</span> <span class="n">diode_curr_new</span><span class="p">)</span>
        <span class="n">phase_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">phase_array</span><span class="p">,</span> <span class="n">new_phase</span><span class="p">)</span>

        <span class="k">while</span> <span class="n">diode_curr_new</span> <span class="o">&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">diode_curr_array</span><span class="p">)</span> <span class="o">-</span> <span class="mi">5</span><span class="p">:</span>
            <span class="c1"># check for abort event</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">abort</span><span class="o">.</span><span class="n">is_set</span><span class="p">():</span>
                <span class="k">return</span>
            <span class="c1"># check for limits of diode range, readjust iris if necessary</span>
            <span class="k">if</span> <span class="n">diode_curr_new</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">400</span><span class="p">]:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">tuneIris</span><span class="p">()</span>

            <span class="c1"># calculate phase after step</span>
            <span class="n">new_phase</span> <span class="o">=</span> <span class="n">new_phase</span> <span class="o">+</span> <span class="n">direction</span><span class="o">*</span><span class="n">phase_step</span>
            <span class="c1"># Check if phase is within limits, then step. otherwise shift phase</span>
            <span class="c1"># and return.</span>
            <span class="k">if</span> <span class="n">new_phase</span> <span class="o">&gt;</span> <span class="n">phase_max</span> <span class="ow">or</span> <span class="n">new_phase</span> <span class="o">&lt;</span> <span class="n">phase_min</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">new_phase</span> <span class="o">&gt;</span> <span class="n">phase_max</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Phase at upper limit, reducing by 360 deg.&#39;</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">hidden</span><span class="p">[</span><span class="s1">&#39;SignalPhase&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">new_phase</span> <span class="o">-</span> <span class="mi">360</span><span class="o">*</span><span class="n">deg_step</span>
                    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
                    <span class="k">return</span>
                <span class="k">elif</span> <span class="n">new_phase</span> <span class="o">&lt;</span> <span class="n">phase_min</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Phase at lower limit, increasing by 360 deg.&#39;</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">hidden</span><span class="p">[</span><span class="s1">&#39;SignalPhase&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">new_phase</span> <span class="o">+</span> <span class="mi">360</span><span class="o">*</span><span class="n">deg_step</span>
                    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
                    <span class="k">return</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">hidden</span><span class="p">[</span><span class="s1">&#39;SignalPhase&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">new_phase</span>
                    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wait</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">hidden</span><span class="p">[</span><span class="s1">&#39;SignalPhase&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">new_phase</span>
                <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wait</span><span class="p">)</span>

            <span class="n">diode_curr_new</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hidden</span><span class="p">[</span><span class="s1">&#39;DiodeCurrent&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wait</span><span class="p">)</span>
            <span class="n">diode_curr_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">diode_curr_array</span><span class="p">,</span> <span class="n">diode_curr_new</span><span class="p">)</span>
            <span class="n">phase_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">phase_array</span><span class="p">,</span> <span class="n">new_phase</span><span class="p">)</span>

            <span class="c1"># set a tuning timeout if Xepr is not responsive</span>
            <span class="k">if</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">t0</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tuning_timeout</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Phase tuning timeout.&#39;</span><span class="p">)</span>
                <span class="k">break</span>

        <span class="c1"># set phase to best value</span>
        <span class="n">phase_max</span> <span class="o">=</span> <span class="n">phase_array</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">diode_curr_array</span><span class="p">)]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hidden</span><span class="p">[</span><span class="s1">&#39;SignalPhase&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">phase_max</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wait</span><span class="p">)</span></div>

<div class="viewcode-block" id="CustomXepr.getQValueFromXepr"><a class="viewcode-back" href="../api/customxepr.html#main.CustomXepr.getQValueFromXepr">[docs]</a>    <span class="nd">@queued_exec</span><span class="p">(</span><span class="n">job_queue</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">getQValueFromXepr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">temperature</span><span class="o">=</span><span class="mi">298</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Gets the Q-Value as determined by Xepr, averaged over 20 readouts, and saves it</span>
<span class="sd">        in the specified file.</span>

<span class="sd">        :param str path: Directory where Q-Value reading is saved with</span>
<span class="sd">            corresponding temperature and time-stamp.</span>
<span class="sd">        :param float temperature: Temperature in Kelvin during Q-Value measurement.</span>

<span class="sd">        :returns: Measured Q-Value.</span>
<span class="sd">        :rtype: float</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_for_xepr</span><span class="p">():</span>
            <span class="k">return</span>

        <span class="n">wait_old</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">wait</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wait</span> <span class="o">=</span> <span class="mi">1</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Reading Q-value.&#39;</span><span class="p">)</span>

        <span class="n">att</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hidden</span><span class="p">[</span><span class="s1">&#39;PowerAtten&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span>  <span class="c1"># remember current attenuation</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wait</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hidden</span><span class="p">[</span><span class="s1">&#39;OpMode&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="s1">&#39;Tune&#39;</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wait</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hidden</span><span class="p">[</span><span class="s1">&#39;RefArm&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="s1">&#39;On&#39;</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wait</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hidden</span><span class="p">[</span><span class="s1">&#39;PowerAtten&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="mi">33</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wait</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hidden</span><span class="p">[</span><span class="s1">&#39;ModeZoom&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="mi">2</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wait</span><span class="p">)</span>

        <span class="n">q_values</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span>

        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">iteration</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">40</span><span class="p">):</span>
            <span class="n">q_values</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">q_values</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">hidden</span><span class="p">[</span><span class="s1">&#39;QValue&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">hidden</span><span class="p">[</span><span class="s1">&#39;PowerAtten&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="mi">32</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wait</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hidden</span><span class="p">[</span><span class="s1">&#39;ModeZoom&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wait</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hidden</span><span class="p">[</span><span class="s1">&#39;RefArm&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="s1">&#39;On&#39;</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wait</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hidden</span><span class="p">[</span><span class="s1">&#39;OpMode&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="s1">&#39;Operate&#39;</span>

        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">tuneFreq</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tuneFreq</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tuneBias</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tuneFreq</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">hidden</span><span class="p">[</span><span class="s1">&#39;PowerAtten&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">att</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wait</span><span class="p">)</span>
        <span class="n">q_mean</span> <span class="o">=</span> <span class="n">q_values</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="n">q_stderr</span> <span class="o">=</span> <span class="n">q_values</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">path</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s1">&#39;QValues.txt&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_saveQValue2File</span><span class="p">(</span><span class="n">temperature</span><span class="p">,</span> <span class="n">q_mean</span><span class="p">,</span> <span class="n">q_stderr</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">q_mean</span> <span class="o">&gt;</span> <span class="mi">3000</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Q = </span><span class="si">%i</span><span class="s1">+/-</span><span class="si">%i</span><span class="s1">.&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">q_mean</span><span class="p">,</span> <span class="n">q_stderr</span><span class="p">))</span>
        <span class="k">elif</span> <span class="n">q_mean</span> <span class="o">&lt;=</span> <span class="mi">3000</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;Q = </span><span class="si">%i</span><span class="s1">+/-</span><span class="si">%i</span><span class="s1"> is very small. &#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">q_mean</span><span class="p">,</span> <span class="n">q_stderr</span><span class="p">)</span> <span class="o">+</span>
                           <span class="s1">&#39;Please check on experiment.&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">wait</span> <span class="o">=</span> <span class="n">wait_old</span>

        <span class="k">return</span> <span class="n">q_mean</span></div>

<div class="viewcode-block" id="CustomXepr.getQValueCalc"><a class="viewcode-back" href="../api/customxepr.html#main.CustomXepr.getQValueCalc">[docs]</a>    <span class="nd">@queued_exec</span><span class="p">(</span><span class="n">job_queue</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">getQValueCalc</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">temperature</span><span class="o">=</span><span class="mi">298</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculates Q-value by fitting the cavity mode picture to a Lorentzian</span>
<span class="sd">        resonance with a polynomial baseline. It uses all available zoom factors</span>
<span class="sd">        to resolve both sharp and broad resonances (high and low Q-values, respectively).</span>

<span class="sd">        :param str path: Directory where Q-Value reading is saved with</span>
<span class="sd">            corresponding temperature and time-stamp.</span>
<span class="sd">        :param float temperature: Temperature in Kelvin during a Q-value</span>
<span class="sd">            measurement. Defaults to room temperature.</span>

<span class="sd">        :returns: :class:`mode_picture.ModePicture` instance.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_for_xepr</span><span class="p">():</span>
            <span class="k">return</span>

        <span class="n">wait_old</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">wait</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wait</span> <span class="o">=</span> <span class="mi">1</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Reading Q-value.&#39;</span><span class="p">)</span>
        <span class="n">att</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hidden</span><span class="p">[</span><span class="s1">&#39;PowerAtten&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span>  <span class="c1"># remember current attenuation</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wait</span><span class="p">)</span>
        <span class="n">freq</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hidden</span><span class="p">[</span><span class="s1">&#39;FrequencyMon&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span>  <span class="c1"># get current frequency</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wait</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">hidden</span><span class="p">[</span><span class="s1">&#39;OpMode&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="s1">&#39;Tune&#39;</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wait</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hidden</span><span class="p">[</span><span class="s1">&#39;RefArm&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="s1">&#39;Off&#39;</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wait</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hidden</span><span class="p">[</span><span class="s1">&#39;PowerAtten&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="mi">33</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">hidden</span><span class="p">[</span><span class="s1">&#39;PowerAtten&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="mi">20</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>

        <span class="c1"># collect mode pictures for different zoom levels</span>
        <span class="n">mode_pic_data</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">for</span> <span class="n">mode_zoom</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">8</span><span class="p">]:</span>
            <span class="n">y_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">hidden</span><span class="p">[</span><span class="s1">&#39;ModeZoom&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">mode_zoom</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>

            <span class="n">n_points</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hidden</span><span class="p">[</span><span class="s1">&#39;DataRange&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wait</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">n_points</span><span class="p">):</span>
                <span class="n">y_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">y_data</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">hidden</span><span class="p">[</span><span class="s1">&#39;Data&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">])</span>

            <span class="n">mode_pic_data</span><span class="p">[</span><span class="n">mode_zoom</span><span class="p">]</span> <span class="o">=</span> <span class="n">y_data</span>

        <span class="n">mp</span> <span class="o">=</span> <span class="n">ModePicture</span><span class="p">(</span><span class="n">mode_pic_data</span><span class="p">,</span> <span class="n">freq</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">hidden</span><span class="p">[</span><span class="s1">&#39;PowerAtten&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="mi">30</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wait</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hidden</span><span class="p">[</span><span class="s1">&#39;ModeZoom&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wait</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hidden</span><span class="p">[</span><span class="s1">&#39;RefArm&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="s1">&#39;On&#39;</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wait</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hidden</span><span class="p">[</span><span class="s1">&#39;OpMode&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="s1">&#39;Operate&#39;</span>

        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">tuneFreq</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tuneFreq</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tuneBias</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tuneFreq</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">hidden</span><span class="p">[</span><span class="s1">&#39;PowerAtten&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">att</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wait</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">mp</span><span class="o">.</span><span class="n">qvalue</span> <span class="o">&gt;</span> <span class="mi">3000</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Q = </span><span class="si">%i</span><span class="s1">+/-</span><span class="si">%i</span><span class="s1">.&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">mp</span><span class="o">.</span><span class="n">qvalue</span><span class="p">,</span> <span class="n">mp</span><span class="o">.</span><span class="n">qvalue_stderr</span><span class="p">))</span>
        <span class="k">elif</span> <span class="n">mp</span><span class="o">.</span><span class="n">qvalue</span> <span class="o">&lt;=</span> <span class="mi">3000</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;Q = </span><span class="si">%i</span><span class="s1">+/-</span><span class="si">%i</span><span class="s1"> is very small. &#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">mp</span><span class="o">.</span><span class="n">qvalue</span><span class="p">,</span> <span class="n">mp</span><span class="o">.</span><span class="n">qvalue_stderr</span><span class="p">)</span> <span class="o">+</span>
                           <span class="s1">&#39;Please check on experiment.&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">path</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">elif</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
            <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s1">&#39;QValues.txt&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_saveQValue2File</span><span class="p">(</span><span class="n">temperature</span><span class="p">,</span> <span class="n">mp</span><span class="o">.</span><span class="n">qvalue</span><span class="p">,</span> <span class="n">mp</span><span class="o">.</span><span class="n">qvalue_stderr</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span>
            <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s1">&#39;ModePicture</span><span class="si">{0:03d}</span><span class="s1">K.txt&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">temperature</span><span class="p">)))</span>
            <span class="n">mp</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">wait</span> <span class="o">=</span> <span class="n">wait_old</span>

        <span class="k">return</span> <span class="n">mp</span></div>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_saveQValue2File</span><span class="p">(</span><span class="n">temperature</span><span class="p">,</span> <span class="n">qvalue</span><span class="p">,</span> <span class="n">qvalue_stderr</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>

        <span class="n">delim</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span>
        <span class="n">newline</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>

        <span class="n">time_str</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1"> %H:%M&#39;</span><span class="p">)</span>
        <span class="n">line</span> <span class="o">=</span> <span class="n">delim</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">time_str</span><span class="p">,</span> <span class="n">temperature</span><span class="p">,</span> <span class="n">qvalue</span><span class="p">,</span> <span class="n">qvalue_stderr</span><span class="p">,</span> <span class="n">newline</span><span class="p">])</span>

        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">header</span> <span class="o">=</span> <span class="n">delim</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s1">&#39;Time stamp&#39;</span><span class="p">,</span> <span class="s1">&#39;Temperature [K]&#39;</span><span class="p">,</span> <span class="s1">&#39;QValue&#39;</span><span class="p">,</span>
                                 <span class="s1">&#39;Standard error&#39;</span><span class="p">,</span> <span class="n">newline</span><span class="p">])</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">header</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>

<div class="viewcode-block" id="CustomXepr.runXeprExperiment"><a class="viewcode-back" href="../api/customxepr.html#main.CustomXepr.runXeprExperiment">[docs]</a>    <span class="nd">@queued_exec</span><span class="p">(</span><span class="n">job_queue</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">runXeprExperiment</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exp</span><span class="p">,</span> <span class="n">retune</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Runs the Xepr experiment given `exp`. Keyword arguments (kwargs)</span>
<span class="sd">        allow the user to pass experiment parameters. If multiple scans are</span>
<span class="sd">        performed, the frequency is tuned between scans.</span>

<span class="sd">        If connected to a temperature controller, the temperature during the</span>
<span class="sd">        measurements is monitored.</span>

<span class="sd">        :param exp: Xepr experiment object.</span>
<span class="sd">        :param bool retune: Retune iris and freq between scans (default: False).</span>
<span class="sd">        :param kwargs: Keyword arguments corresponding to measurement</span>
<span class="sd">            parameters.</span>

<span class="sd">        :returns: Xepr data set object.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_for_xepr</span><span class="p">():</span>
            <span class="k">return</span>

        <span class="c1"># -----------set experiment parameters if given in kwargs--------------</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="n">exp</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wait</span><span class="p">)</span>

        <span class="n">message</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;Measurement &quot;</span><span class="si">%s</span><span class="s1">&quot; is running. &#39;</span> <span class="o">%</span> <span class="n">exp</span><span class="o">.</span><span class="n">aqGetExpName</span><span class="p">())</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>

        <span class="c1"># -------------------start experiment----------------------------------</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">feed</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">feed</span><span class="o">.</span><span class="n">mercury</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">temperature_history</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">temperature_history</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="n">exp</span><span class="o">.</span><span class="n">select</span><span class="p">()</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wait</span><span class="p">)</span>
        <span class="n">exp</span><span class="o">.</span><span class="n">aqExpRun</span><span class="p">()</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wait</span><span class="p">)</span>

        <span class="c1"># wait for experiment to start</span>
        <span class="k">while</span> <span class="ow">not</span> <span class="n">exp</span><span class="o">.</span><span class="n">isRunning</span><span class="p">:</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wait</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">retune</span><span class="p">:</span>  <span class="c1"># schedule pause after scan to retune</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">exp</span><span class="o">.</span><span class="n">aqExpPause</span><span class="p">()</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wait</span><span class="p">)</span>

        <span class="c1"># count the number of temperature stability violations</span>
        <span class="n">n_out</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># start at n_out = 0</span>

        <span class="k">while</span> <span class="n">exp</span><span class="o">.</span><span class="n">isRunning</span> <span class="ow">or</span> <span class="n">exp</span><span class="o">.</span><span class="n">isPaused</span><span class="p">:</span>

            <span class="c1"># check for abort event</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">abort</span><span class="o">.</span><span class="n">is_set</span><span class="p">():</span>
                <span class="n">exp</span><span class="o">.</span><span class="n">aqExpPause</span><span class="p">()</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Aborted by user.&#39;</span><span class="p">)</span>
                <span class="k">return</span>

            <span class="n">nb_scans_done</span> <span class="o">=</span> <span class="n">exp</span><span class="p">[</span><span class="s1">&#39;NbScansDone&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wait</span><span class="p">)</span>
            <span class="n">nb_scans_to_do</span> <span class="o">=</span> <span class="n">exp</span><span class="p">[</span><span class="s1">&#39;NbScansToDo&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wait</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">status</span><span class="p">(</span><span class="s1">&#39;Recording scan </span><span class="si">%i</span><span class="s1">/</span><span class="si">%i</span><span class="s1">.&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">nb_scans_done</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nb_scans_to_do</span><span class="p">))</span>

            <span class="k">if</span> <span class="n">retune</span><span class="p">:</span>
                <span class="c1"># tune frequency and iris when a new slice scan starts</span>
                <span class="k">if</span> <span class="n">exp</span><span class="o">.</span><span class="n">isPaused</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">nb_scans_done</span> <span class="o">==</span> <span class="n">nb_scans_to_do</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">status</span><span class="p">(</span><span class="s1">&#39;Checking tuned.&#39;</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">tuneFreq</span><span class="p">(</span><span class="n">tolerance</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
                    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wait</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">tuneFreq</span><span class="p">(</span><span class="n">tolerance</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
                    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wait</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">tuneIris</span><span class="p">(</span><span class="n">tolerance</span><span class="o">=</span><span class="mi">7</span><span class="p">)</span>
                    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wait</span><span class="p">)</span>

                    <span class="c1"># start next scan</span>
                    <span class="n">exp</span><span class="o">.</span><span class="n">aqExpRun</span><span class="p">()</span>
                    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wait</span><span class="p">)</span>

                    <span class="c1"># wait for scan to start and schedule next pause</span>
                    <span class="k">while</span> <span class="ow">not</span> <span class="n">exp</span><span class="o">.</span><span class="n">isRunning</span><span class="p">:</span>
                        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                    <span class="n">exp</span><span class="o">.</span><span class="n">aqExpPause</span><span class="p">()</span>
                    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wait</span><span class="p">)</span>

            <span class="c1"># record temperature and warn if fluctuations exceed the tolerance</span>
            <span class="k">if</span> <span class="n">temperature_history</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">temperature_curr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">feed</span><span class="o">.</span><span class="n">readings</span><span class="p">[</span><span class="s1">&#39;Temp&#39;</span><span class="p">]</span>
                <span class="n">temperature_history</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">temperature_history</span><span class="p">,</span> <span class="n">temperature_curr</span><span class="p">)</span>
                <span class="c1"># increment the number of violations n_out if temperature unstable</span>
                <span class="n">n_out</span> <span class="o">+=</span> <span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">temperature_history</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">temperature_history</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&gt;</span>
                          <span class="mi">2</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">temperature_tolerance</span><span class="p">)</span>
                <span class="c1"># warn once for every 120 violations</span>
                <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">mod</span><span class="p">(</span><span class="n">n_out</span><span class="p">,</span> <span class="mi">120</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">u</span><span class="s1">&#39;Temperature fluctuations &gt; +/-</span><span class="si">%s</span><span class="s1">K.&#39;</span>
                                   <span class="o">%</span> <span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">temperature_tolerance</span><span class="p">))</span>
                    <span class="n">n_out</span> <span class="o">+=</span> <span class="mi">1</span>  <span class="c1"># prevent from warning again next second</span>

                <span class="c1"># Pause measurement and suspend all pending jobs after 15 min</span>
                <span class="c1"># of temperature instability</span>
                <span class="k">if</span> <span class="n">n_out</span> <span class="o">&gt;</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">15</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;Temperature could not be stabilized for &#39;</span> <span class="o">+</span>
                                   <span class="s1">&#39;15 min. Pausing current measurement and &#39;</span> <span class="o">+</span>
                                   <span class="s1">&#39;all pending jobs.&#39;</span><span class="p">)</span>
                    <span class="n">exp</span><span class="o">.</span><span class="n">aqExpPause</span><span class="p">()</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">running</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
                    <span class="k">return</span>

            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

        <span class="c1"># get temperature stability over scan if mercury was connected</span>
        <span class="k">if</span> <span class="n">temperature_history</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">temperature_var</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">temperature_history</span><span class="p">)</span> <span class="o">-</span> <span class="nb">min</span><span class="p">(</span><span class="n">temperature_history</span><span class="p">)</span>
            <span class="n">temperature_mean</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">temperature_history</span><span class="p">))</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">u</span><span class="s1">&#39;Temperature stable at (</span><span class="si">%.2f</span><span class="s1">+/-</span><span class="si">%.2f</span><span class="s1">)K during scans.&#39;</span>
                        <span class="o">%</span> <span class="p">(</span><span class="n">temperature_mean</span><span class="p">,</span> <span class="n">temperature_var</span> <span class="o">/</span> <span class="mi">2</span><span class="p">))</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;All scans complete.&#39;</span><span class="p">)</span>

        <span class="c1"># -----------------get acquired data set from Xepr and return----------</span>
        <span class="c1"># switch viewpoint to experiment which just finished running</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wait</span><span class="p">)</span>
        <span class="n">exp_title</span> <span class="o">=</span> <span class="n">exp</span><span class="o">.</span><span class="n">aqGetExpName</span><span class="p">()</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wait</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">XeprCmds</span><span class="o">.</span><span class="n">aqExpSelect</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">exp_title</span><span class="p">)</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wait</span><span class="p">)</span>

        <span class="c1"># get data set</span>
        <span class="n">dset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">xepr</span><span class="o">.</span><span class="n">XeprDataset</span><span class="p">()</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wait</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">dset</span></div>

<div class="viewcode-block" id="CustomXepr.saveCurrentData"><a class="viewcode-back" href="../api/customxepr.html#main.CustomXepr.saveCurrentData">[docs]</a>    <span class="nd">@queued_exec</span><span class="p">(</span><span class="n">job_queue</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">saveCurrentData</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">exp</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Saves the data from given experiment in Xepr to the specified path. If</span>
<span class="sd">        `exp` is `None` the currently displayed data set is saved.</span>

<span class="sd">        Xepr only allows file paths shorter than 128 characters.</span>

<span class="sd">        :param str path: Absolute path to save data file.</span>
<span class="sd">        :param str title: Experiment title. Defaults to the file name if not given.</span>
<span class="sd">        :param exp: Xepr experiment instance associated with data set. Defaults</span>
<span class="sd">            to currently selected experiment if not given.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_for_xepr</span><span class="p">():</span>
            <span class="k">return</span>

        <span class="n">directory</span><span class="p">,</span> <span class="n">filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>

        <span class="c1"># check if path is valid</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">directory</span><span class="p">):</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;The directory &quot;</span><span class="si">%s</span><span class="s1">&quot; does not exist.&#39;</span> <span class="o">%</span> <span class="n">directory</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">running</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
            <span class="k">return</span>

        <span class="c1"># check if path is valid</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">path</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">128</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Invalid path. Full path must be shorter than 110 &#39;</span> <span class="o">+</span>
                         <span class="s1">&#39;characters.&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">running</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
            <span class="k">return</span>

        <span class="c1"># switch viewpoint to experiment if given</span>
        <span class="k">if</span> <span class="n">exp</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">exp_title</span> <span class="o">=</span> <span class="n">exp</span><span class="o">.</span><span class="n">aqGetExpName</span><span class="p">()</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wait</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">XeprCmds</span><span class="o">.</span><span class="n">aqExpSelect</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">exp_title</span><span class="p">)</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wait</span><span class="p">)</span>

        <span class="c1"># title = filename if no title given</span>
        <span class="k">if</span> <span class="n">title</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">title</span> <span class="o">=</span> <span class="n">filename</span>

        <span class="c1"># save data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">XeprCmds</span><span class="o">.</span><span class="n">ddPath</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wait</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">XeprCmds</span><span class="o">.</span><span class="n">vpSave</span><span class="p">(</span><span class="s1">&#39;Current Primary&#39;</span><span class="p">,</span> <span class="n">title</span><span class="p">,</span>  <span class="n">path</span><span class="p">)</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wait</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Data saved to </span><span class="si">%s</span><span class="s1">.&#39;</span> <span class="o">%</span> <span class="n">path</span><span class="p">)</span></div>

<div class="viewcode-block" id="CustomXepr.setStandby"><a class="viewcode-back" href="../api/customxepr.html#main.CustomXepr.setStandby">[docs]</a>    <span class="nd">@queued_exec</span><span class="p">(</span><span class="n">job_queue</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">setStandby</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Sets the magnetic field to zero and the MW bridge to standby.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_for_xepr</span><span class="p">():</span>
            <span class="k">return</span>

        <span class="c1"># check if WindDown experiment already exists, otherwise create</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">wd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">xepr</span><span class="o">.</span><span class="n">XeprExperiment</span><span class="p">(</span><span class="s1">&#39;WindDown&#39;</span><span class="p">)</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wait</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">ExperimentError</span><span class="p">:</span>
            <span class="n">wd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">xepr</span><span class="o">.</span><span class="n">XeprExperiment</span><span class="p">(</span><span class="s1">&#39;WindDown&#39;</span><span class="p">,</span> <span class="n">exptype</span><span class="o">=</span><span class="s1">&#39;C.W.&#39;</span><span class="p">,</span>
                                          <span class="n">axs1</span><span class="o">=</span><span class="s1">&#39;Field&#39;</span><span class="p">,</span> <span class="n">ordaxs</span><span class="o">=</span><span class="s1">&#39;Signal channel&#39;</span><span class="p">)</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wait</span><span class="p">)</span>

        <span class="n">wd</span><span class="o">.</span><span class="n">aqExpActivate</span><span class="p">()</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wait</span><span class="p">)</span>
        <span class="n">wd</span><span class="p">[</span><span class="s1">&#39;CenterField&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wait</span><span class="p">)</span>
        <span class="n">wd</span><span class="p">[</span><span class="s1">&#39;AtCenter&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wait</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">hidden</span><span class="p">[</span><span class="s1">&#39;OpMode&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="s1">&#39;Tune&#39;</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hidden</span><span class="p">[</span><span class="s1">&#39;OpMode&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="s1">&#39;Stand By&#39;</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wait</span><span class="p">)</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;EPR set to standby.&#39;</span><span class="p">)</span></div>

<span class="c1"># =============================================================================</span>
<span class="c1"># set up cryostat functions</span>
<span class="c1"># =============================================================================</span>

<div class="viewcode-block" id="CustomXepr.setTemperature"><a class="viewcode-back" href="../api/customxepr.html#main.CustomXepr.setTemperature">[docs]</a>    <span class="nd">@queued_exec</span><span class="p">(</span><span class="n">job_queue</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">setTemperature</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">target</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Sets the target temperature for the ESR900 cryostat and waits for it to</span>
<span class="sd">        stabilize within :attr:`temp_wait_time` with fluctuations below</span>
<span class="sd">        :attr:`temperature_tolerance`.</span>

<span class="sd">        Warns the user if this takes too long.</span>

<span class="sd">        :param float target: Target temperature in Kelvin.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_for_mercury</span><span class="p">():</span>
            <span class="k">return</span>

        <span class="c1"># create instance variable here to allow outside access</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_temperature_target</span> <span class="o">=</span> <span class="n">target</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Setting target temperature to </span><span class="si">%s</span><span class="s1">K.&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">_temperature_target</span><span class="p">)</span>

        <span class="c1"># set temperature and wait to stabilize</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">feed</span><span class="o">.</span><span class="n">control</span><span class="o">.</span><span class="n">t_setpoint</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_temperature_target</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_waitStable</span><span class="p">()</span>

        <span class="c1"># check if gas flow is too high for temperature set point</span>
        <span class="c1"># if yes, reduce minimum value until target is reached</span>
        <span class="n">ht</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">heater_target</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_temperature_target</span><span class="p">)</span>
        <span class="n">fmin</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">feed</span><span class="o">.</span><span class="n">readings</span><span class="p">[</span><span class="s1">&#39;FlowMin&#39;</span><span class="p">]</span>

        <span class="n">heater_too_strong</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">feed</span><span class="o">.</span><span class="n">readings</span><span class="p">[</span><span class="s1">&#39;HeaterVolt&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">1.2</span><span class="o">*</span><span class="n">ht</span><span class="p">)</span>
        <span class="n">flow_at_min</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">feed</span><span class="o">.</span><span class="n">readings</span><span class="p">[</span><span class="s1">&#39;FlowPercent&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">fmin</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">heater_too_strong</span> <span class="ow">and</span> <span class="n">flow_at_min</span><span class="p">:</span>

            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;Gas flow is too high, trying to reduce.&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">feed</span><span class="o">.</span><span class="n">control</span><span class="o">.</span><span class="n">flow_auto</span> <span class="o">=</span> <span class="s1">&#39;ON&#39;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">feed</span><span class="o">.</span><span class="n">gasflow</span><span class="o">.</span><span class="n">gmin</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">feed</span><span class="o">.</span><span class="n">readings</span><span class="p">[</span><span class="s1">&#39;FlowMin&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_waitStable</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Waits for the cryostat temperature to stabilize within the specified</span>
<span class="sd">        tolerance :attr:`temperature_tolerance`. Releases after it has been</span>
<span class="sd">        stable for :attr:`temp_wait_time` seconds (default of 120 sec).</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># time in sec after which a timeout warning is issued</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_temperature_timeout</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ramp_time</span><span class="p">()</span> <span class="o">+</span> <span class="mi">30</span><span class="o">*</span><span class="mi">60</span><span class="p">)</span>  <span class="c1"># in sec</span>
        <span class="c1"># counter for elapsed seconds since temperature has been stable</span>
        <span class="n">stable_counter</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="c1"># counter for setting gas flow to manual</span>
        <span class="n">gasflow_man_counter</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="c1"># starting time</span>
        <span class="n">t0</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Waiting for temperature to stabilize.&#39;</span><span class="p">)</span>

        <span class="k">while</span> <span class="n">stable_counter</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">temp_wait_time</span><span class="p">:</span>
            <span class="c1"># check for abort command</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">abort</span><span class="o">.</span><span class="n">is_set</span><span class="p">():</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Aborted by user.&#39;</span><span class="p">)</span>
                <span class="k">return</span>

            <span class="c1"># set gas flow to minimum for temperatures above 247K, this improves</span>
            <span class="c1"># the PID control and speeds up stabilization</span>
            <span class="k">if</span> <span class="n">gasflow_man_counter</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">feed</span><span class="o">.</span><span class="n">readings</span><span class="p">[</span><span class="s1">&#39;Temp&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">247</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_temperature_target</span> <span class="o">&gt;</span> <span class="mi">247</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">feed</span><span class="o">.</span><span class="n">control</span><span class="o">.</span><span class="n">flow_auto</span> <span class="o">=</span> <span class="s1">&#39;OFF&#39;</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">feed</span><span class="o">.</span><span class="n">control</span><span class="o">.</span><span class="n">flow</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">feed</span><span class="o">.</span><span class="n">readings</span><span class="p">[</span><span class="s1">&#39;FlowMin&#39;</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">feed</span><span class="o">.</span><span class="n">control</span><span class="o">.</span><span class="n">flow_auto</span> <span class="o">=</span> <span class="s1">&#39;ON&#39;</span>
                <span class="n">gasflow_man_counter</span> <span class="o">+=</span> <span class="mi">1</span>

            <span class="c1"># check temperature deviation</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">T_diff</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_temperature_target</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">feed</span><span class="o">.</span><span class="n">readings</span><span class="p">[</span><span class="s1">&#39;Temp&#39;</span><span class="p">])</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">T_diff</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">temperature_tolerance</span><span class="p">:</span>
                <span class="n">stable_counter</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">feed</span><span class="o">.</span><span class="n">refresh</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">status</span><span class="p">(</span><span class="s1">&#39;Waiting for temperature to stabilize.&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">stable_counter</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">feed</span><span class="o">.</span><span class="n">refresh</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">status</span><span class="p">(</span><span class="s1">&#39;Stable for </span><span class="si">%s</span><span class="s1">/</span><span class="si">%s</span><span class="s1"> sec.&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">stable_counter</span><span class="p">,</span>
                                                         <span class="bp">self</span><span class="o">.</span><span class="n">temp_wait_time</span><span class="p">))</span>
                <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">feed</span><span class="o">.</span><span class="n">refresh</span><span class="p">)</span>

            <span class="c1"># warn once if stabilization is taking longer than expected</span>
            <span class="k">if</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">t0</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">_temperature_timeout</span><span class="p">:</span>
                <span class="n">t0</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;Temperature is taking too long to stabilize.&#39;</span><span class="p">)</span>

        <span class="n">message</span> <span class="o">=</span> <span class="s1">&#39;Mercury iTC: Temperature is stable at </span><span class="si">%s</span><span class="s1">K.&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">_temperature_target</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>

<div class="viewcode-block" id="CustomXepr.heater_target"><a class="viewcode-back" href="../api/customxepr.html#main.CustomXepr.heater_target">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">heater_target</span><span class="p">(</span><span class="n">temperature</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculates the ideal heater voltage for a given temperature.</span>

<span class="sd">        :param float temperature: Temperature in Kelvin.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="mf">4.5</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">temperature</span><span class="p">)</span> <span class="o">-</span> <span class="mf">5.5</span></div>

    <span class="k">def</span> <span class="nf">_ramp_time</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculates the expected time in sec to reach the target temperature.</span>
<span class="sd">        Assumes a max ramping speed of 5 K/min if &quot;ramp&quot; is turned off.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">feed</span><span class="o">.</span><span class="n">readings</span><span class="p">[</span><span class="s1">&#39;TempRampEnable&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;ON&#39;</span><span class="p">:</span>
            <span class="n">expected_time</span> <span class="o">=</span> <span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_temperature_target</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">feed</span><span class="o">.</span><span class="n">readings</span><span class="p">[</span><span class="s1">&#39;Temp&#39;</span><span class="p">])</span> <span class="o">/</span>
                             <span class="bp">self</span><span class="o">.</span><span class="n">feed</span><span class="o">.</span><span class="n">readings</span><span class="p">[</span><span class="s1">&#39;TempRamp&#39;</span><span class="p">])</span>  <span class="c1"># in min</span>
        <span class="k">else</span><span class="p">:</span>  <span class="c1"># assume ramp of 5 K/min</span>
            <span class="n">expected_time</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_temperature_target</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">feed</span><span class="o">.</span><span class="n">readings</span><span class="p">[</span><span class="s1">&#39;Temp&#39;</span><span class="p">])</span> <span class="o">/</span> <span class="mi">5</span>
        <span class="k">return</span> <span class="n">expected_time</span> <span class="o">*</span> <span class="mi">60</span>  <span class="c1"># return value in sec</span>

<div class="viewcode-block" id="CustomXepr.setTempRamp"><a class="viewcode-back" href="../api/customxepr.html#main.CustomXepr.setTempRamp">[docs]</a>    <span class="nd">@queued_exec</span><span class="p">(</span><span class="n">job_queue</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">setTempRamp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ramp</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Sets the temperature ramp for the ESR900 cryostat in K/min.</span>

<span class="sd">        :param float ramp: Ramp in Kelvin per minute.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_for_mercury</span><span class="p">():</span>
            <span class="k">return</span>

        <span class="c1"># set temperature and wait to stabilize</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">feed</span><span class="o">.</span><span class="n">control</span><span class="o">.</span><span class="n">ramp</span> <span class="o">=</span> <span class="n">ramp</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Setting temperature ramp to </span><span class="si">%s</span><span class="s1"> K/min.&#39;</span> <span class="o">%</span> <span class="n">ramp</span><span class="p">)</span></div>

<span class="c1"># =============================================================================</span>
<span class="c1"># set up Keithley functions</span>
<span class="c1"># =============================================================================</span>

<div class="viewcode-block" id="CustomXepr.transferMeasurement"><a class="viewcode-back" href="../api/customxepr.html#main.CustomXepr.transferMeasurement">[docs]</a>    <span class="nd">@queued_exec</span><span class="p">(</span><span class="n">job_queue</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">transferMeasurement</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">smu_gate</span><span class="o">=</span><span class="n">K_CONF</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;Sweep&#39;</span><span class="p">,</span> <span class="s1">&#39;gate&#39;</span><span class="p">),</span>
                            <span class="n">smu_drain</span><span class="o">=</span><span class="n">K_CONF</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;Sweep&#39;</span><span class="p">,</span> <span class="s1">&#39;drain&#39;</span><span class="p">),</span>
                            <span class="n">vg_start</span><span class="o">=</span><span class="n">K_CONF</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;Sweep&#39;</span><span class="p">,</span> <span class="s1">&#39;VgStart&#39;</span><span class="p">),</span>
                            <span class="n">vg_stop</span><span class="o">=</span><span class="n">K_CONF</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;Sweep&#39;</span><span class="p">,</span> <span class="s1">&#39;VgStop&#39;</span><span class="p">),</span>
                            <span class="n">vg_step</span><span class="o">=</span><span class="n">K_CONF</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;Sweep&#39;</span><span class="p">,</span> <span class="s1">&#39;VgStep&#39;</span><span class="p">),</span>
                            <span class="n">vd_list</span><span class="o">=</span><span class="n">K_CONF</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;Sweep&#39;</span><span class="p">,</span> <span class="s1">&#39;VdList&#39;</span><span class="p">),</span>
                            <span class="n">t_int</span><span class="o">=</span><span class="n">K_CONF</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;Sweep&#39;</span><span class="p">,</span> <span class="s1">&#39;tInt&#39;</span><span class="p">),</span>
                            <span class="n">delay</span><span class="o">=</span><span class="n">K_CONF</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;Sweep&#39;</span><span class="p">,</span> <span class="s1">&#39;delay&#39;</span><span class="p">),</span>
                            <span class="n">pulsed</span><span class="o">=</span><span class="n">K_CONF</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;Sweep&#39;</span><span class="p">,</span> <span class="s1">&#39;pulsed&#39;</span><span class="p">),</span>
                            <span class="n">path</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Records a transfer curve and saves returns the resulting data. If a valid</span>
<span class="sd">        path is given, the data is also saved as a .txt file.</span>

<span class="sd">        :param smu_gate: Name of SMU attached to the gate electrode of an FET.</span>
<span class="sd">        :param smu_drain: Name of SMU attached to the drain electrode of an FET.</span>
<span class="sd">        :param float vg_start: Start voltage of transfer sweep in Volts.</span>
<span class="sd">        :param float vg_stop: End voltage of transfer sweep in Volts.</span>
<span class="sd">        :param float vg_step: Voltage step size for transfer sweep in Volts.</span>
<span class="sd">        :param list vd_list: List of drain voltage steps in Volts.</span>
<span class="sd">        :param float t_int: Integration time in sec for every data point.</span>
<span class="sd">        :param float delay: Settling time in sec before every measurement. Set</span>
<span class="sd">            to -1 for for automatic delay.</span>
<span class="sd">        :param bool pulsed: True or False for pulsed or continuous measurements.</span>
<span class="sd">        :param str path: File path to save transfer curve data as .txt file.</span>

<span class="sd">        :returns: Transfer curve data.</span>
<span class="sd">        :rtype: :class:`keithley2600.TransistorSweepData`</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_for_keithley</span><span class="p">():</span>
            <span class="k">return</span>

        <span class="n">smu_gate</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">keithley</span><span class="p">,</span> <span class="n">smu_gate</span><span class="p">)</span>
        <span class="n">smu_drain</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">keithley</span><span class="p">,</span> <span class="n">smu_drain</span><span class="p">)</span>

        <span class="n">sd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">keithley</span><span class="o">.</span><span class="n">transferMeasurement</span><span class="p">(</span><span class="n">smu_gate</span><span class="p">,</span> <span class="n">smu_drain</span><span class="p">,</span> <span class="n">vg_start</span><span class="p">,</span>
                                               <span class="n">vg_stop</span><span class="p">,</span> <span class="n">vg_step</span><span class="p">,</span> <span class="n">vd_list</span><span class="p">,</span> <span class="n">t_int</span><span class="p">,</span>
                                               <span class="n">delay</span><span class="p">,</span> <span class="n">pulsed</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">path</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">sd</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">sd</span></div>

<div class="viewcode-block" id="CustomXepr.outputMeasurement"><a class="viewcode-back" href="../api/customxepr.html#main.CustomXepr.outputMeasurement">[docs]</a>    <span class="nd">@queued_exec</span><span class="p">(</span><span class="n">job_queue</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">outputMeasurement</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">smu_gate</span><span class="o">=</span><span class="n">K_CONF</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;Sweep&#39;</span><span class="p">,</span> <span class="s1">&#39;gate&#39;</span><span class="p">),</span>
                          <span class="n">smu_drain</span><span class="o">=</span><span class="n">K_CONF</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;Sweep&#39;</span><span class="p">,</span> <span class="s1">&#39;drain&#39;</span><span class="p">),</span>
                          <span class="n">vd_start</span><span class="o">=</span><span class="n">K_CONF</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;Sweep&#39;</span><span class="p">,</span> <span class="s1">&#39;VdStart&#39;</span><span class="p">),</span>
                          <span class="n">vd_stop</span><span class="o">=</span><span class="n">K_CONF</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;Sweep&#39;</span><span class="p">,</span> <span class="s1">&#39;VdStop&#39;</span><span class="p">),</span>
                          <span class="n">vd_step</span><span class="o">=</span><span class="n">K_CONF</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;Sweep&#39;</span><span class="p">,</span> <span class="s1">&#39;VdStep&#39;</span><span class="p">),</span>
                          <span class="n">vg_list</span><span class="o">=</span><span class="n">K_CONF</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;Sweep&#39;</span><span class="p">,</span> <span class="s1">&#39;VgList&#39;</span><span class="p">),</span>
                          <span class="n">t_int</span><span class="o">=</span><span class="n">K_CONF</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;Sweep&#39;</span><span class="p">,</span> <span class="s1">&#39;tInt&#39;</span><span class="p">),</span>
                          <span class="n">delay</span><span class="o">=</span><span class="n">K_CONF</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;Sweep&#39;</span><span class="p">,</span> <span class="s1">&#39;delay&#39;</span><span class="p">),</span>
                          <span class="n">pulsed</span><span class="o">=</span><span class="n">K_CONF</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;Sweep&#39;</span><span class="p">,</span> <span class="s1">&#39;pulsed&#39;</span><span class="p">),</span>
                          <span class="n">path</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Records an output curve and returns the resulting data. If a valid</span>
<span class="sd">        path is given, the data is also saved as a .txt file.</span>

<span class="sd">        :param smu_gate: Name of SMU attached to the gate electrode of an FET.</span>
<span class="sd">        :param smu_drain: Name of SMU attached to the drain electrode of an FET.</span>
<span class="sd">        :param float vd_start: Start voltage of output sweep in Volts .</span>
<span class="sd">        :param float vd_stop: End voltage of output sweep in Volts.</span>
<span class="sd">        :param float vd_step: Voltage step size for output sweep in Volts.</span>
<span class="sd">        :param list vg_list: List of gate voltage steps in Volts.</span>
<span class="sd">        :param float t_int: Integration time in sec for every data point.</span>
<span class="sd">        :param float delay: Settling time in sec before every measurement. Set</span>
<span class="sd">            to -1 for for automatic delay.</span>
<span class="sd">        :param bool pulsed: True or False for pulsed or continuous measurements.</span>
<span class="sd">        :param str path: File path to save output curve data as .txt file.</span>

<span class="sd">        :returns: Output curve data.</span>
<span class="sd">        :rtype: :class:`keithley2600.TransistorSweepData`</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_for_keithley</span><span class="p">():</span>
            <span class="k">return</span>

        <span class="n">smu_gate</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">keithley</span><span class="p">,</span> <span class="n">smu_gate</span><span class="p">)</span>
        <span class="n">smu_drain</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">keithley</span><span class="p">,</span> <span class="n">smu_drain</span><span class="p">)</span>

        <span class="n">sd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">keithley</span><span class="o">.</span><span class="n">outputMeasurement</span><span class="p">(</span><span class="n">smu_gate</span><span class="p">,</span> <span class="n">smu_drain</span><span class="p">,</span> <span class="n">vd_start</span><span class="p">,</span>
                                             <span class="n">vd_stop</span><span class="p">,</span> <span class="n">vd_step</span><span class="p">,</span> <span class="n">vg_list</span><span class="p">,</span> <span class="n">t_int</span><span class="p">,</span>
                                             <span class="n">delay</span><span class="p">,</span> <span class="n">pulsed</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">path</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">sd</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">sd</span></div>

<div class="viewcode-block" id="CustomXepr.setGateVoltage"><a class="viewcode-back" href="../api/customxepr.html#main.CustomXepr.setGateVoltage">[docs]</a>    <span class="nd">@queued_exec</span><span class="p">(</span><span class="n">job_queue</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">setGateVoltage</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">smu_gate</span><span class="o">=</span><span class="n">K_CONF</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;Sweep&#39;</span><span class="p">,</span> <span class="s1">&#39;gate&#39;</span><span class="p">)):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Sets the gate bias of the given keithley, grounds other SMUs.</span>

<span class="sd">        :param float v: Gate voltage in Volts.</span>
<span class="sd">        :param str smu_gate: Name of SMU. Defaults to the SMU saved as gate.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_for_keithley</span><span class="p">():</span>
            <span class="k">return</span>

        <span class="n">gate</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">keithley</span><span class="p">,</span> <span class="n">smu_gate</span><span class="p">)</span>

        <span class="c1"># turn off all remaining SMUs</span>
        <span class="n">other_smus</span> <span class="o">=</span> <span class="nb">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">a</span><span class="p">:</span> <span class="n">a</span> <span class="o">!=</span> <span class="n">smu_gate</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">keithley</span><span class="o">.</span><span class="n">SMU_LIST</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">smu_name</span> <span class="ow">in</span> <span class="n">other_smus</span><span class="p">:</span>
            <span class="n">smu</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">keithley</span><span class="p">,</span> <span class="n">smu_name</span><span class="p">)</span>
            <span class="n">smu</span><span class="o">.</span><span class="n">source</span><span class="o">.</span><span class="n">output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">keithley</span><span class="o">.</span><span class="n">OUTPUT_OFF</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">keithley</span><span class="o">.</span><span class="n">rampToVoltage</span><span class="p">(</span><span class="n">gate</span><span class="p">,</span> <span class="n">targetVolt</span><span class="o">=</span><span class="n">v</span><span class="p">,</span> <span class="n">delay</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">stepSize</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">v</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">keithley</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span></div>

<div class="viewcode-block" id="CustomXepr.applyDrainCurrent"><a class="viewcode-back" href="../api/customxepr.html#main.CustomXepr.applyDrainCurrent">[docs]</a>    <span class="nd">@queued_exec</span><span class="p">(</span><span class="n">job_queue</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">applyDrainCurrent</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">smu</span><span class="o">=</span><span class="n">K_CONF</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;Sweep&#39;</span><span class="p">,</span> <span class="s1">&#39;drain&#39;</span><span class="p">)):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Applies a specified current to the selected Keithley SMU.</span>

<span class="sd">        :param float i: Drain current in Ampere.</span>
<span class="sd">        :param str smu: Name of SMU. Defaults to the SMU saved as drain.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_for_keithley</span><span class="p">():</span>
            <span class="k">return</span>

        <span class="n">smu</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">keithley</span><span class="p">,</span> <span class="n">smu</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">keithley</span><span class="o">.</span><span class="n">applyCurrent</span><span class="p">(</span><span class="n">smu</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">keithley</span><span class="o">.</span><span class="n">beep</span><span class="p">(</span><span class="mf">0.3</span><span class="p">,</span> <span class="mi">2400</span><span class="p">)</span></div>

<span class="c1"># =============================================================================</span>
<span class="c1"># Helper methods</span>
<span class="c1"># =============================================================================</span>

    <span class="k">def</span> <span class="nf">_check_for_mercury</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Checks if a mercury instance has been passed and is connected to an</span>
<span class="sd">        an actual instrument.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">feed</span> <span class="ow">or</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">feed</span><span class="o">.</span><span class="n">mercury</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;No Mercury instance supplied. Functions that &#39;</span> <span class="o">+</span>
                        <span class="s1">&#39;require a connected cryostat will not work.&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">feed</span><span class="o">.</span><span class="n">mercury</span><span class="o">.</span><span class="n">connected</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;MercuryiTC is not connected. Functions that &#39;</span> <span class="o">+</span>
                        <span class="s1">&#39;require a connected cryostat will not work.&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">True</span>

    <span class="k">def</span> <span class="nf">_check_for_keithley</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Checks if a keithley instance has been passed and is connected to an</span>
<span class="sd">        an actual instrument.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">keithley</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;No Keithley instance supplied. Functions that &#39;</span> <span class="o">+</span>
                        <span class="s1">&#39;require a connected Keithley SMU will not work.&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">keithley</span><span class="o">.</span><span class="n">connected</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Keithley is not connected. Functions that &#39;</span> <span class="o">+</span>
                        <span class="s1">&#39;require a connected Keithley will not work.&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">True</span>

    <span class="k">def</span> <span class="nf">_check_for_xepr</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">xepr</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;No Xepr instance supplied. Functions that &#39;</span> <span class="o">+</span>
                        <span class="s1">&#39;require Xepr will not work.&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">xepr</span><span class="o">.</span><span class="n">XeprActive</span><span class="p">():</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Xepr API not active. Please activate Xepr API by &#39;</span> <span class="o">+</span>
                        <span class="s1">&#39;pressing &quot;Processing &gt; XeprAPI &gt; Enable Xepr API&quot;&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">XeprCmds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">xepr</span><span class="o">.</span><span class="n">XeprCmds</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">hidden</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">hidden</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">xepr</span><span class="o">.</span><span class="n">XeprExperiment</span><span class="p">(</span><span class="s1">&#39;AcqHidden&#39;</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">True</span>
            <span class="k">except</span> <span class="n">ExperimentError</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Xepr is not connected to the spectrometer.&#39;</span> <span class="o">+</span>
                            <span class="s1">&#39;Please connect by pressing &quot;Acquisition &gt; &#39;</span> <span class="o">+</span>
                            <span class="s1">&#39;Connect To Spectrometer...&quot;&#39;</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">False</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">True</span></div>


<span class="c1"># =============================================================================</span>
<span class="c1"># Set up loggers to send emails and write to log files</span>
<span class="c1"># =============================================================================</span>

<span class="k">def</span> <span class="nf">setup_root_logger</span><span class="p">(</span><span class="n">to_address</span><span class="p">):</span>

    <span class="c1"># Set up email notification handler for WARNING messages and above</span>
    <span class="n">root_logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">()</span>
    <span class="c1"># noinspection PyUnresolvedReferences</span>
    <span class="n">root_logger</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">STATUS</span><span class="p">)</span>

    <span class="c1"># find all email handlers (there should be none)</span>
    <span class="n">eh</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">root_logger</span><span class="o">.</span><span class="n">handlers</span> <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">==</span> <span class="n">logging</span><span class="o">.</span><span class="n">handlers</span><span class="o">.</span><span class="n">SMTPHandler</span><span class="p">]</span>
    <span class="c1"># find all file handlers (there should be none)</span>
    <span class="n">fh</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">root_logger</span><span class="o">.</span><span class="n">handlers</span> <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">==</span> <span class="n">logging</span><span class="o">.</span><span class="n">FileHandler</span><span class="p">]</span>

    <span class="c1"># define standard format of logging messages</span>
    <span class="n">f</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">Formatter</span><span class="p">(</span><span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">%(asctime)s</span><span class="s1"> </span><span class="si">%(name)s</span><span class="s1"> </span><span class="si">%(levelname)s</span><span class="s1">: &#39;</span> <span class="o">+</span>
                          <span class="s1">&#39;</span><span class="si">%(message)s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">datefmt</span><span class="o">=</span><span class="s1">&#39;%H:%M&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">eh</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="c1"># create and add email handler</span>

        <span class="n">email_handler</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">handlers</span><span class="o">.</span><span class="n">SMTPHandler</span><span class="p">(</span><span class="s1">&#39;localhost&#39;</span><span class="p">,</span> <span class="s1">&#39;ss2151@cam.ac.uk&#39;</span><span class="p">,</span>
                                                     <span class="n">to_address</span><span class="p">,</span> <span class="s1">&#39;Xepr logger&#39;</span><span class="p">)</span>
        <span class="n">email_handler</span><span class="o">.</span><span class="n">setFormatter</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
        <span class="n">email_handler</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">CONF</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;CustomXepr&#39;</span><span class="p">,</span> <span class="s1">&#39;email_handler_level&#39;</span><span class="p">))</span>

        <span class="n">root_logger</span><span class="o">.</span><span class="n">addHandler</span><span class="p">(</span><span class="n">email_handler</span><span class="p">)</span>

    <span class="c1"># =========================================================================</span>
    <span class="c1"># Set up logging to file</span>
    <span class="c1"># =========================================================================</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">fh</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">home_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">expanduser</span><span class="p">(</span><span class="s1">&#39;~&#39;</span><span class="p">)</span>
        <span class="n">logging_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">home_path</span><span class="p">,</span> <span class="s1">&#39;.CustomXepr&#39;</span><span class="p">,</span> <span class="s1">&#39;LOG_FILES&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">logging_path</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">logging_path</span><span class="p">)</span>

        <span class="n">log_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">logging_path</span><span class="p">,</span> <span class="s1">&#39;root_logger &#39;</span>
                                <span class="o">+</span> <span class="n">time</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2">_%H-%M-%S&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;.txt&#39;</span><span class="p">)</span>
        <span class="n">file_handler</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">FileHandler</span><span class="p">(</span><span class="n">log_file</span><span class="p">)</span>
        <span class="n">file_handler</span><span class="o">.</span><span class="n">setFormatter</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
        <span class="n">file_handler</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">)</span>
        <span class="n">root_logger</span><span class="o">.</span><span class="n">addHandler</span><span class="p">(</span><span class="n">file_handler</span><span class="p">)</span>


<span class="n">setup_root_logger</span><span class="p">(</span><span class="n">CONF</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;CustomXepr&#39;</span><span class="p">,</span> <span class="s1">&#39;notify_address&#39;</span><span class="p">))</span>
</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2019, Sam Schott

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    
    
      <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../_static/jquery.js"></script>
        <script type="text/javascript" src="../_static/underscore.js"></script>
        <script type="text/javascript" src="../_static/doctools.js"></script>
    

  

  <script type="text/javascript" src="../_static/js/theme.js"></script>

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>  
  <style>
    /* Sidebar header (and topbar for mobile) */
    .wy-side-nav-search, .wy-nav-top {
      background: #511D43;
    }
    /* Sidebar */
    .wy-nav-side {
      background: #31363B;
    }
  </style>


</body>
</html>